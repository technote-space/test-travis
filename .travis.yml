language: php

sudo: false
dist: trusty

notifications:
  email: false
  slack:
    rooms:
      - secure: yHcw8QFMnWjUVQmzBYQ19+2SKOeAORYpn53mIgdGXeImflXuZaqwe07N38IAFNpKOlsXbVzF0uyFZkF3Ru0KiDu0IMGu7WEpTMMFFI/UNfY/fwoEjOOVnMrU2eTAnFJ3F/C2O/OaG7Wa3fnYGm50Vx9j5PSWI4qUP1PIHH+a6RpDWPUmbTlq5F3lFXAdbB6ZMfv3wl+3lVTHiGh9FcTS0YfYVZmR7serB+iJue6F+GMrtaRdzSW+qWjY2jMIXOkqi5cEGTkNahfykZO0+fEgyMFIokN+Crg546LfIUkFtSvRVywbsDnYxpoQoF1Z4e8H/KmRNC6k6/KiL4Qnl+oRKADuJjaY9bCgaRcDEIpA/aeu17Ey60pnSvUhS38KjM/G8kKmLcwJZXECzKLujUYtsnY7WvOS2agYvOexDmOLQeDueYJ3xsdCBAQSFTHiY1jPmYvdUseSRgVtElTw48iN+goUyVTZ8T7F5Tscqf7PQefMu1fJsuSN4yq1AUBr8xF8bpNN+TD5rFrbZ4I02MhOmTZv4vxbnc79mSFURJvuNyPmCsfCBNd4JPtDwEQk0Kf9YhUrYcDwsknB0nReH/0q0zpaIOAj4gD/5d/AUXWjfdOSGfDfzf1nc62m7AY9IH4rbyW+0Vxgov1/EaYUGkHFdItk19v5BmWq9+nNRJKZvi4=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  directories:
    - "$HOME/.composer/cache"
    - "$HOME/.npm"

stages:
  - name: check
    if: branch = master and tag IS blank and type = pull_request
  - name: test
    if: branch = master and tag IS blank and type = pull_request
  - name: prepare
    if: branch = master and tag IS blank and type = pull_request
  - name: deploy
    if: tag IS present

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash tests/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.9
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash tests/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash tests/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash tests/bin/js/js-test.sh


    - stage: prepare
      language: node_js
      node_js: '11'
      dist: trusty
      script:
        - source tests/bin/deploy/env.sh &&  bash tests/bin/deploy/wp-check-diff.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source tests/bin/deploy/env.sh && bash tests/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        name: "${RELEASE_TITLE}"
        draft: true
        api_key:
          secure: vIo/kxTQOQpBq3zb0LpMnWHS2IYvzV0G7XkJweQnfppfkklUO/y/cnXKHOZhoT+V22MymjI9cJnVTO718y8ZGfvdLv6LIgrQjYfM3xt0NCISJCeuQReEH/e0Fel9wtJ19WMRnmA39w429ZfxpSzlsCV2Cv0N0lrcNJOc5xVwVZAtsBpdjROkIg0q26W3nFLuI5y1NnKm+RF28YO7PTPn0mqxEG/TLiLLCiY6USZq9J/vetiIdX4fd9B5WAWGNVRkM1FSZ4rl1W2vFGtMT607HOSAtj7bq7gNW9Qh6FDhAO+/NoayhxJcj/2dan0yT/MmdXsK4yTc19MCRbQe8oN+1BZnG7PVcHCpjo85YEEc5AL8iVQ+rdH8xypvR60rcPfVkR3wnNI1ExXSx61oZmhO2bU9fN7P7ahcKK76v5h52t0kSbykWI6AsGLhgXzB/o6FGIfFAoqHAjp0p+jZQxMowSPrdLejk8OLMSUSv8qBphrsvIhzWuf4Fzu1dMY2/RJjv6+9lISyHmFyVD97CZyMsPlGXYIwIKgffGDsG5LOoj5z6Zpy+lZo/7yTncozWRlTUIBimglfU6D6u9sgqaIdKxQ5OD891JbTW4xcV7RBDYxko8cBSHgeMey+9+Wg81vczw1YLGeKyTK6ujWoBaVCLmPB9JjGLWPUhCX2y8D85Ag=
        file: "${RELEASE_FILE}"
        overwrite: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      deploy:
        provider: script
        script: source tests/bin/deploy/env.sh && bash tests/bin/deploy/wp-release.sh

  allow_failures:
    - env: WP_VERSION=4.9
    - env: WP_VERSION=3.9
