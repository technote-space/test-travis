language: php

sudo: false
dist: trusty

notifications:
  email: false
  slack:
    secure: WAIJ8bbzNvlIbgsza+dX+017mVWHsZPgjj4ZpQ+roji2c5SV7L5FBEIxna+Zwq89Ngdvq2I7mHBJ+qsJ9gvSrlgbhsYX4ihMnTui2eBa7anySYwVoleLcWDh8oiLz2YDO6upfRs/IYTJdLUEZreol2qTOMgpDNPcNNRKAI/4DsvmvnZSCp7KSvsvLXbiMBXt6Ptmj0OBm2tSdTLFwFCSpBccjL+rI+6rKu2dInRbrPkPrmim/sK1CCOjz8YeyLsqXOSUvgsIpNUkaf5OGgliNhQ0eYIbwBzux3/iE0cY1U11991BRP0MidCgszSP5xXJsjypDx5omdRq6bHNIX7hUye10L82hX1o9WbQMVcc/P+aS5DV1OqesjRT66vwqGQMeyUPY6gmu/yVcpKgT5jB4cYip4I3qUNkM5McEjmMSAkw035Hz0FkwYwF/M0Jqzkp7ssGbGgMx55JEiNDdg8Prk0HmIFHLbYWYd0Uj4w+WuHszxkx7yOwtR7xjIP4mvrbmD+UIImqcxIH/RB/BjWxwNOtLIYSfx07i47RTtmO6LUSsdPdimiVfF92FkaAEqOMMso9MUJX4zbByS39mfmYUv5Mumr+18B09QwMd4WsWQ5eowb+3k/5LhlXR/7Qv28P13uTiLllac/54rlwrF3/q3vgoPsE3PE7C/CDpVnQQGk=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.npm

stages:
  - name: check
    if: branch = master and tag IS blank and type = pull_request
  - name: test
    if: branch = master and tag IS blank and type = pull_request
  - name: deploy
    if: tag IS present

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash tests/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash tests/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.9
      script: bash tests/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash tests/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash tests/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash tests/bin/js/js-test.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source tests/bin/deploy/env.sh
        - bash tests/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: be+VVnNbkweCydikkzwWWtwl8ujtR6U+Q8UG4tghoEyVednJZIo3HQ64gnVO2LpY4xZzw3IzXfcAk9yjaj690khBMZR9tjAXcFuBUSmlkY7YK3fuVfGYD0BuRzUqDVFy+cjvvQQgUYE8iPty9JnRJuSc7RRhgAcQjiZdblLogi02ROgDOKdmriD/4XZQOMpXiqmudicwXWGHC3OyqEIFfEMRZ6Tni4DTQywpVnFU4sOXpYZ3c8Vxb/pTZqbf8wZOvbMxvzWKYL0bfefnPuZxVmoIIBIE38k98lYclUNlyCCY9z9BgEQhgorH/NEosGV+eeMe6U+WLVN9JfOaY2VsJniiMndW7+rq6AklFxetveVczYdN343rQxY8KGX1wFZPYVsVrC6/ZxgvbvIjynl90oID87luDAhseHEBzKo4b6hUCkvmQwQkWf5Mt3d62fNAlbSCTsP4ivON0eXij+EvBqrA4Ax2d17uFLrJUiVuaetCMzW1L1AKTHGRSpE8bD+wrUNCqSTE4fPaJFemA7GAD0A4GiF/dDfJbq6DYgJ//Q6jYwVL4193o41ZyQx2ghdDj5cZg2jKjFtMhrdTvNXTw3CUku9iX0a8CJuTh02VRgnyrOA2p8d9OPLB/xkHF4GDtKfCX78g1NngK14lReModZNHTFYcfHPve0+FCHg2DgE=
        file: "${RELEASE_FILE}"
        on:
          tags: true

  allow_failures:
    - env: WP_VERSION=4.9
    - env: WP_VERSION=3.9
